<script>
  const initBtn = document.getElementById("initBtn");
  const initResult = document.getElementById("initResult");
  const transactionResult = document.getElementById("transactionResult");
  const simplyConnectContainer = document.getElementById("simplyConnect");

  // Add a Delete Payment Token button dynamically
  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "ğŸ—‘ï¸ åˆ é™¤ä¿å­˜çš„æ”¯ä»˜æ–¹å¼";
  deleteBtn.style.marginLeft = "10px";
  deleteBtn.addEventListener("click", () => {
    const tokenId = prompt("è¯·è¾“å…¥è¦åˆ é™¤çš„ paymentTokenIdï¼š");
    if (!tokenId) {
      alert("æœªè¾“å…¥ paymentTokenIdã€‚");
      return;
    }

    if (!window.simplyConnect || !window.simplyConnect.deletePaymentToken) {
      alert("âš ï¸ Simply Connect å°šæœªåˆå§‹åŒ–æˆ–ä¸æ”¯æŒ deletePaymentTokenã€‚");
      return;
    }

    window.simplyConnect.deletePaymentToken(tokenId)
      .then(result => {
        console.log("âœ… åˆ é™¤ç»“æœï¼š", result);
        alert("âœ… æ”¯ä»˜æ–¹å¼å·²åˆ é™¤ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°ä»¥äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚");
      })
      .catch(err => {
        console.error("âŒ åˆ é™¤å¤±è´¥ï¼š", err);
        alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + (err?.message || JSON.stringify(err)));
      });
  });

  document.body.insertBefore(deleteBtn, document.getElementById("resultContainer"));

  function clearWidget() {
    simplyConnectContainer.innerHTML = "";
    simplyConnectContainer.style.display = "block";
  }

  function initializeSimplyConnect(sessionId) {
    clearWidget();
    window._currentSimplyConnectSessionId = sessionId;

    try {
      window.simplyConnect({
        env: 'int', // 'prod' for production
        renderTo: "#simplyConnect",
        sessionId: sessionId,
        eventCallbacks: {
          onResult: function(result) {
            console.log("Transaction Result:", result);
            if (!result || !result.result || !result.result.status) {
              initResult.textContent = "âŒ æ”¯ä»˜å¤±è´¥ï¼šsessionId æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚";
              simplyConnectContainer.style.display = "none";
              transactionResult.textContent = "å›  session é—®é¢˜æœªè¿›è¡Œäº¤æ˜“ã€‚";
              return;
            }
            simplyConnectContainer.style.display = "none";
            transactionResult.textContent = JSON.stringify(result, null, 2);
            initResult.textContent = `âœ… æ”¯ä»˜å®Œæˆï¼ŒçŠ¶æ€ï¼š${result.result.status}`;
          },
          onError: function(error) {
            console.error("Payment Error:", error);
            initResult.textContent = "âŒ åˆå§‹åŒ–æˆ–æ”¯ä»˜è¿‡ç¨‹å‡ºé”™ï¼š" + (error?.reason || JSON.stringify(error));
            simplyConnectContainer.style.display = "none";
            transactionResult.textContent = "å› é”™è¯¯æœªè¿›è¡Œäº¤æ˜“ã€‚";
          }
        },
        uiConfig: {
          countryCode: "CN",
          locale: "zh",
          textDirection: "ltr",
          i18n: {
            cc_card: "ä¿¡ç”¨å¡",
            lbl_my_methods: "æˆ‘çš„æ”¯ä»˜æ–¹å¼",
            lbl_other_methods: "è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼",
            delete_payment_token_title: "åˆ é™¤æ”¯ä»˜ä»¤ç‰Œ",
            delete_payment_token_confirm: "ç¡®å®šè¦åˆ é™¤æ­¤æ”¯ä»˜ä»¤ç‰Œå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
            btn_delete_payment_token: "åˆ é™¤",
            btn_pay_with: "ä½¿ç”¨ {method} æ”¯ä»˜",
            btn_pay: "æ”¯ä»˜",
            btn_cancel: "å–æ¶ˆ",
            msg_success: "æ”¯ä»˜æˆåŠŸ",
            msg_processing: "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™â€¦",
            msg_error: "å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•",
            msg_invalid_session: "ä¼šè¯æ— æ•ˆæˆ–å·²è¿‡æœŸ",
            card_number: "å¡å·",
            card_expiry: "æœ‰æ•ˆæœŸ",
            card_cvc: "å®‰å…¨ç  (CVC)",
            card_name: "æŒå¡äººå§“å",
            lbl_saved_cards: "å·²ä¿å­˜çš„å¡ç‰‡",
            lbl_save_card: "ä¿å­˜æ­¤å¡ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨"
          },
          error_i18n: {
            decline: "æ‚¨çš„æ”¯ä»˜è¢«æ‹’ç»ï¼Œè¯·è”ç³»å‘å¡è¡Œã€‚",
            timeoutretry: "è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚",
            donothonor: "å‘å¡è¡Œæ‹’ç»è¯¥äº¤æ˜“ï¼Œè¯·è”ç³»é“¶è¡Œã€‚"
          },
          payButton: 'textButton'
        }
      });

      initResult.textContent = "âœ… Simply Connect åˆå§‹åŒ–æˆåŠŸã€‚æ”¯ä»˜è¡¨å•åº”è¯¥å·²æ˜¾ç¤ºã€‚";
    } catch (err) {
      console.error("åˆå§‹åŒ–é”™è¯¯ï¼š", err);
      initResult.textContent = "âŒ åˆå§‹åŒ–å¤±è´¥ï¼š" + (err?.message || JSON.stringify(err));
      simplyConnectContainer.style.display = "none";
    }
  }

  initBtn.addEventListener("click", () => {
    const sessionId = document.getElementById("sessionId").value.trim();
    if (!sessionId) {
      initResult.textContent = "âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ sessionIdã€‚";
      return;
    }
    initializeSimplyConnect(sessionId);
  });
</script>
